<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge | Brain Training</title>
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d8, #ff9a8b);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 font-sans">
    <div class="container max-w-md glass p-6 text-center text-white">
        <h1 class="text-3xl font-bold mb-6 uppercase tracking-wider">Math Challenge</h1>

        <!-- Instructions Section -->
        <div id="game-instructions" class="glass p-5 mb-6">
            <p class="mb-4">Solve as many math problems as you can in 60 seconds!</p>
            <button id="start-math-game" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition transform hover:scale-105">
                Start Game
            </button>
        </div>

        <!-- Game Area (Initially Hidden) -->
        <div id="math-game-area" class="glass p-5 hidden">
            <div class="flex justify-between mb-4">
                <div id="timer" class="text-xl">Time: <span id="time-left">60</span>s</div>
                <div id="score" class="text-xl">Score: <span id="current-score">0</span></div>
            </div>
            
            <div id="current-problem" class="text-4xl font-bold my-8">15 + 16 = ?</div>
            
            <div class="flex items-center justify-center space-x-2">
                <input type="number" id="answer-input" placeholder="Answer" class="w-24 p-3 text-center text-xl bg-white text-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <button id="submit-answer" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition transform hover:scale-105">
                    Submit
                </button>
            </div>
        </div>

        <!-- Results Area (Initially Hidden) -->
        <div id="results-area" class="glass p-5 hidden">
            <h2 class="text-2xl font-bold mb-4">Game Over!</h2>
            <p class="text-xl mb-2">Your final score: <span id="final-score">0</span></p>
            <p class="text-xl mb-6">Experience gained: <span id="xp-gained">0</span> XP</p>
            <button id="back-to-home" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full transition transform hover:scale-105">
                Back to Home
            </button>
        </div>
    </div>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) tg.expand();

        // DOM Elements
        const gameInstructions = document.getElementById("game-instructions");
        const mathGameArea = document.getElementById("math-game-area");
        const resultsArea = document.getElementById("results-area");
        const startButton = document.getElementById("start-math-game");
        const problemContainer = document.getElementById("current-problem");
        const answerInput = document.getElementById("answer-input");
        const submitAnswerButton = document.getElementById("submit-answer");
        const timeLeftSpan = document.getElementById("time-left");
        const currentScoreSpan = document.getElementById("current-score");
        const finalScoreSpan = document.getElementById("final-score");
        const xpGainedSpan = document.getElementById("xp-gained");
        const backToHomeButton = document.getElementById("back-to-home");

        // Game variables
        let countdown;
        let timeLeft = 60; // 60 seconds
        let currentScore = 0;
        let xpGained = 0;
        let currentProblem = {};

        // User data from localStorage
        let userData;

        // Load user data
        function loadUserData() {
            const savedData = localStorage.getItem('brainTrainingUserData');
            if (savedData) {
                userData = JSON.parse(savedData);
            } else {
                userData = {
                    level: 1,
                    xp: 0,
                    lives: 5,
                    lastPlayed: new Date(),
                    stats: {
                        intelligence: 10,
                        sports: 5,
                        languages: 3
                    },
                    inventory: []
                };
            }
        }

        // Save user data
        function saveUserData() {
            localStorage.setItem('brainTrainingUserData', JSON.stringify(userData));
        }

        // Generate a random math problem based on difficulty
        function generateProblem() {
            // Difficulty increases with player level
            const difficulty = Math.min(10, Math.max(1, Math.floor((userData?.level || 1) / 2)));
            const operations = ['+', '-', '*'];

            let num1, num2, operation;

            // More complex problems for higher difficulty
            if (difficulty > 5) {
                num1 = Math.floor(Math.random() * difficulty * 10);
                num2 = Math.floor(Math.random() * difficulty * 5);
                operation = operations[Math.floor(Math.random() * operations.length)];
            } else {
                num1 = Math.floor(Math.random() * difficulty * 10);
                num2 = Math.floor(Math.random() * difficulty * 10);
                operation = operations[Math.floor(Math.random() * 2)]; // Only + and - for lower difficulty
            }

            // Ensure subtraction doesn't result in negative for beginners
            if (operation === '-' && difficulty < 3 && num2 > num1) {
                [num1, num2] = [num2, num1]; // Swap numbers
            }

            let answer;
            let problemText;

            switch (operation) {
                case '+':
                    answer = num1 + num2;
                    problemText = `${num1} + ${num2} = ?`;
                    break;
                case '-':
                    answer = num1 - num2;
                    problemText = `${num1} - ${num2} = ?`;
                    break;
                case '*':
                    answer = num1 * num2;
                    problemText = `${num1} Ã— ${num2} = ?`;
                    break;
            }

            return {
                text: problemText,
                answer: answer
            };
        }

        // Start the math game
        function startMathGame() {
            gameInstructions.style.display = "none";
            mathGameArea.style.display = "block";

            // Reset game variables
            timeLeft = 60;
            currentScore = 0;
            currentScoreSpan.textContent = currentScore;

            // Generate first problem
            currentProblem = generateProblem();
            problemContainer.textContent = currentProblem.text;
            answerInput.value = "";
            answerInput.focus();

            // Start countdown
            countdown = setInterval(updateTimer, 1000);
            updateTimer();
        }

        // Update timer display and check if time is up
        function updateTimer() {
            timeLeftSpan.textContent = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(countdown);
                endGame();
            } else {
                timeLeft--;
            }
        }

        // Check the user's answer
        function checkAnswer() {
            const userAnswer = parseInt(answerInput.value);

            if (!isNaN(userAnswer) && userAnswer === currentProblem.answer) {
                // Correct answer
                currentScore++;
                currentScoreSpan.textContent = currentScore;

                // Generate new problem
                currentProblem = generateProblem();
                problemContainer.textContent = currentProblem.text;
                answerInput.value = "";
                answerInput.focus();
            } else {
                // Incorrect answer - shake the input
                answerInput.classList.add("shake");
                setTimeout(() => {
                    answerInput.classList.remove("shake");
                }, 500);
            }
        }

        // End the game and show results
        function endGame() {
            mathGameArea.style.display = "none";

            // Calculate XP gained (20 XP per correct answer)
            xpGained = currentScore * 20;

            // Update user stats
            loadUserData();
            if (userData) {
                userData.xp += xpGained;
                userData.stats.intelligence += Math.ceil(currentScore / 3); // Boost intelligence

                // Level up check (simple formula: 100 XP per level)
                const newLevel = Math.floor(userData.xp / 100) + 1;
                if (newLevel > userData.level) {
                    userData.level = newLevel;
                    userData.lives++; // Bonus life on level up
                }

                saveUserData();
            }

            // Show results
            finalScoreSpan.textContent = currentScore;
            xpGainedSpan.textContent = xpGained;
            resultsArea.style.display = "block";
        }

        // Event Listeners
        startButton.addEventListener("click", startMathGame);
        submitAnswerButton.addEventListener("click", checkAnswer);

        // Also allow pressing Enter to submit
        answerInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                checkAnswer();
            }
        });

        backToHomeButton.addEventListener("click", () => {
            window.location.href = "index.html";
        });

        // Load user data on page load
        window.onload = function() {
            loadUserData();
            
            // Load theme preference (simple version for standalone file)
            document.body.className = "flex items-center justify-center p-4 font-sans";
        };
    </script>
</body>
</html>
